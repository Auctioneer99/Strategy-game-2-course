let unitObj = `#
# object Cylinder001
#

v  0.0000 0.0000 -5.0000
v  -4.3301 0.9005 -2.5000
v  0.0000 0.9005 -5.0000
v  -4.3301 0.0000 -2.5000
v  -4.3301 0.9005 2.5000
v  -4.3301 0.0000 2.5000
v  0.0000 0.9005 5.0000
v  0.0000 0.0000 5.0000
v  4.3301 0.9005 2.5000
v  4.3301 0.0000 2.5000
v  4.3301 0.9005 -2.5000
v  4.3301 0.0000 -2.5000
v  -3.6931 0.9005 -2.1322
v  0.0000 0.9005 -4.2645
v  -3.6931 0.9005 2.1322
v  0.0000 0.9005 4.2645
v  3.6931 0.9005 2.1322
v  3.6931 0.9005 -2.1322
v  -3.6931 0.5000 -2.1322
v  0.0000 0.5000 -4.2645
v  -3.6931 0.5000 2.1322
v  0.0000 0.5000 4.2645
v  3.6931 0.5000 2.1322
v  3.6931 0.5000 -2.1322
# 24 vertices

vt 0.1201 0.6915 0.2251
vt 0.8911 0.8304 -0.2251
vt 0.1201 0.8304 -0.2251
vt 0.1125 0.6846 0.2251
vt 0.8837 0.8235 -0.2251
vt 0.1125 0.8235 -0.2251
vt 0.8862 0.8245 0.2251
vt 0.1151 0.6856 -0.2251
vt 0.8862 0.6856 -0.2251
vt 0.8911 0.8279 0.2251
vt 0.1200 0.6890 -0.2251
vt 0.8911 0.6890 -0.2251
vt 0.8986 0.8311 0.2251
vt 0.1275 0.6922 -0.2251
vt 0.8986 0.6922 -0.2251
vt 0.1125 0.6856 0.2251
vt 0.8837 0.8245 -0.2251
vt 0.1125 0.8245 -0.2251
vt 0.6326 0.4253 0.0000
vt 0.5270 0.2424 0.0000
vt 0.9494 0.2424 0.0000
vt 0.8438 0.4253 0.0000
vt 0.6326 0.0595 0.0000
vt 0.8438 0.0595 0.0000
vt 0.0876 0.2243 0.4502
vt 0.1625 0.1278 -0.4502
vt 0.1068 0.2243 -0.4502
vt 0.1529 0.1111 -0.4502
vt 0.2740 0.1278 -0.4502
vt 0.2836 0.1111 -0.4502
vt 0.3298 0.2243 -0.4502
vt 0.3490 0.2243 0.4502
vt 0.2740 0.3209 -0.4502
vt 0.2836 0.3375 -0.4502
vt 0.1625 0.3209 -0.4502
vt 0.1529 0.3375 -0.4502
vt 0.1350 0.4955 0.3501
vt 0.8483 0.5624 -0.3501
vt 0.1350 0.5624 -0.3501
vt 0.1373 0.4900 0.3501
vt 0.8507 0.5570 -0.3501
vt 0.1373 0.5570 -0.3501
vt 0.8483 0.5565 0.3501
vt 0.1350 0.4895 -0.3501
vt 0.8483 0.4895 -0.3501
vt 0.8538 0.5627 0.3501
vt 0.1404 0.4957 -0.3501
vt 0.8538 0.4957 -0.3501
vt 0.8452 0.5567 0.3501
vt 0.1319 0.4898 -0.3501
vt 0.8452 0.4898 -0.3501
vt 0.1341 0.4960 0.3501
vt 0.8476 0.5630 -0.3501
vt 0.1341 0.5630 -0.3501
vt 0.8911 0.6915 0.2251
vt 0.8837 0.6846 0.2251
vt 0.1151 0.8245 0.2251
vt 0.1200 0.8279 0.2251
vt 0.1275 0.8311 0.2251
vt 0.8837 0.6856 0.2251
vt 0.8483 0.4955 0.3501
vt 0.8507 0.4900 0.3501
vt 0.1350 0.5565 0.3501
vt 0.1404 0.5627 0.3501
vt 0.1319 0.5567 0.3501
vt 0.8476 0.4960 0.3501
# 66 texture coords

g Cylinder001
f 1/1 2/2 3/3 
f 4/4 5/5 2/6 
f 6/7 7/8 5/9 
f 8/10 9/11 7/12 
f 10/13 11/14 9/15 
f 12/16 3/17 11/18 
f 4/19 1/20 8/21 
f 6/22 4/19 8/21 
f 12/23 10/24 8/21 
f 1/20 12/23 8/21 
f 3/25 13/26 14/27 
f 2/28 15/29 13/26 
f 5/30 16/31 15/29 
f 7/32 17/33 16/31 
f 9/34 18/35 17/33 
f 11/36 14/27 18/35 
f 14/37 19/38 20/39 
f 13/40 21/41 19/42 
f 15/43 22/44 21/45 
f 16/46 23/47 22/48 
f 17/49 24/50 23/51 
f 18/52 20/53 24/54 
f 1/1 4/55 2/2 
f 4/4 6/56 5/5 
f 6/7 8/57 7/8 
f 8/10 10/58 9/11 
f 10/13 12/59 11/14 
f 12/16 1/60 3/17 
f 3/25 2/28 13/26 
f 2/28 5/30 15/29 
f 5/30 7/32 16/31 
f 7/32 9/34 17/33 
f 9/34 11/36 18/35 
f 11/36 3/25 14/27 
f 14/37 13/61 19/38 
f 13/40 15/62 21/41 
f 15/43 16/63 22/44 
f 16/46 17/64 23/47 
f 17/49 18/65 24/50 
f 18/52 14/66 20/53 
# 40 faces

#
# object unitPNG
#

v  0.0000 0.5000 -4.2645
v  -3.6931 0.5000 -2.1322
v  0.0000 0.5000 4.2645
v  -3.6931 0.5000 2.1322
v  3.6931 0.5000 2.1322
v  3.6931 0.5000 -2.1322
# 6 vertices

vt 0.5000 -0.0688 0.2500
vt 0.9955 0.2172 -0.2500
vt 0.5000 1.0753 0.2500
vt 0.9955 0.7893 -0.2500
vt 0.0046 0.7893 -0.2500
vt 0.0046 0.2172 -0.2500
# 6 texture coords

g unitPNG
f 25/67 26/68 27/69 
f 26/68 28/70 27/69 
f 29/71 30/72 27/69 
f 30/72 25/67 27/69 
# 4 faces`;
let box = `#
# object Box001
#

v  19.8953 0.7874 12.0213
v  19.8953 0.7874 -12.0213
v  -19.8953 0.7874 -12.0213
v  -19.8953 0.7874 12.0213
v  21.6535 0.0000 13.7795
v  21.6535 0.0000 -13.7795
v  21.6535 3.9370 -13.7795
v  21.6535 3.9370 13.7795
v  -21.6535 0.0000 -13.7795
v  -21.6535 3.9370 -13.7795
v  -21.6535 0.0000 13.7795
v  -21.6535 3.9370 13.7795
v  19.8953 3.9370 -12.0213
v  19.8953 3.9370 12.0213
v  -19.8953 3.9370 -12.0213
v  -19.8953 3.9370 12.0213
# 16 vertices

vt 0.0395 0.5966 268.2791
vt 0.0160 0.4054 0.0000
vt 0.8941 0.4054 0.0000
vt 0.4427 0.8395 0.0000
vt 0.0160 0.5334 0.0000
vt 0.6242 0.5334 0.0000
vt 0.6242 0.6202 0.0000
vt 0.0160 0.6202 0.0000
vt 0.0160 0.0310 0.0000
vt 0.9715 0.0310 0.0000
vt 0.9715 0.1179 0.0000
vt 0.0160 0.1179 0.0000
vt 0.6242 0.5128 0.0000
vt 0.0160 0.5128 0.0000
vt 0.0160 0.4259 0.0000
vt 0.6242 0.4259 0.0000
vt 0.9715 0.2253 0.0000
vt 0.0160 0.2253 0.0000
vt 0.0160 0.3359 0.0000
vt 0.0160 0.7389 966.1746
vt 0.0275 0.8408 0.0000
vt 0.5501 0.8408 0.0000
vt 0.0160 0.6408 0.0000
vt 0.8941 0.3153 0.0000
vt 0.0275 0.9093 0.0000
vt 0.5501 0.9093 0.0000
vt 0.8941 0.3359 0.0000
vt 0.8941 0.2458 0.0000
vt 0.4427 0.9079 0.0000
vt 0.0395 0.0318 -268.2791
vt 0.9742 0.0318 -268.2791
vt 0.9742 0.5966 268.2791
vt 0.0548 0.6796 0.0000
vt 0.0548 0.7001 -966.1746
vt 0.9718 0.6408 0.0000
vt 0.9330 0.6796 0.0000
vt 0.9714 0.7389 966.1746
vt 0.9327 0.7001 -966.1746
vt 0.0160 0.1384 0.0000
vt 0.9715 0.1384 0.0000
vt 0.0160 0.3153 0.0000
vt 0.0160 0.2458 0.0000
vt 0.9653 0.8395 0.0000
vt 0.9653 0.9079 0.0000
vt 0.8596 0.7977 -358.3313
vt 0.8214 0.7594 0.0000
vt 0.2606 0.7977 358.3313
vt 0.2988 0.7594 0.0000
vt 0.0160 0.7595 355.1476
vt 0.6242 0.7595 -355.1476
vt 0.5854 0.7983 0.0000
vt 0.0548 0.7983 0.0000
# 52 texture coords

g Box001
f 1/1 2/30 3/31 
f 3/31 4/32 1/1 
f 5/5 6/6 7/7 
f 7/7 8/8 5/5 
f 6/9 9/10 10/11 
f 10/11 7/12 6/9 
f 9/13 11/14 12/15 
f 12/15 10/16 9/13 
f 11/17 5/18 8/39 
f 8/39 12/40 11/17 
f 8/49 7/50 13/51 
f 13/51 14/52 8/49 
f 7/23 10/35 15/36 
f 15/36 13/33 7/23 
f 10/45 12/47 16/48 
f 16/48 15/46 10/45 
f 12/37 8/20 14/34 
f 14/34 16/38 12/37 
f 14/21 13/22 2/26 
f 2/26 1/25 14/21 
f 13/19 15/27 3/3 
f 3/3 2/2 13/19 
f 15/44 16/29 4/4 
f 4/4 3/43 15/44 
f 16/24 14/41 1/42 
f 1/42 4/28 16/24 
# 26 faces

`;

/*
function unitmove(event) {
  if (pathPoints[0]) {
    if (tileByID(pathPoints[0]).unitID == null) {
      console.log("Передвижение, путь: " + pathPoints);
      playground.currentUnit.tryMove(temp);
    } else {
      console.log("Атака " + unitByTileID(playground.currentTile).stats.name);
      if (unitByID(playground.currentUnit).stats.ranged == true) {
        playground.currentUnit.tryAttack(pathPoints[0]);
      } else {
        let temp = [];
        for (let i = 1; i < pathPoints.length; i++) temp.push(pathPoints[i]);
        playground.currentUnit.tryMove(temp);
        playground.currentUnit.tryAttack(pathPoints[0]);
      }
    }
  }
  playground.clearPath();
  playground.currentTileID = null;
}
*/

//#endregion

//#region materials
let COLOR_ATTACK = new THREE.MeshStandardMaterial({
  color: 0xbb0000,
  roughness: 0.65,
  metalness: 0.4,
  //wireframe: true,
});
let COLOR_HEALTH = new THREE.MeshStandardMaterial({
  color: 0x00bb00,
  roughness: 0.65,
  metalness: 0.4,
  //wireframe: true,
});
let COLOR_INITIATIVE = new THREE.MeshStandardMaterial({
  color: 0xff8100,
  roughness: 0.65,
  metalness: 0.4,
  //wireframe: true,
});

let COLOR_WHITE = new THREE.MeshStandardMaterial({
  color: 0xffffff,
  emissive: 0xffffff,
  roughness: 0.65,
  metalness: 0.4,
  //wireframe: true,
});
let COLOR_CURRENTUNIT = new THREE.MeshStandardMaterial({
  color: 0x888888,
  emissive: 0x888888,
  roughness: 0.65,
  metalness: 0.4,
  //wireframe: true,
});
let COLOR_RED = new THREE.MeshStandardMaterial({
  color: 0x862b3f,
  emissive: 0x862b3f,
  roughness: 0.65,
  metalness: 0.4,
  //wireframe: true,
});
let COLOR_GREEN = new THREE.MeshBasicMaterial({
  color: 0x004400,
  transparent: true,
  opacity: 0.2,
});
//#endregion
/*
function useAbility(id) {
  console.log("Ability = " + id);
  socket.emit("ability", id);
  //playground.currentUnit.stats.abilities[id].use();
}*/
let objLoader = new THREE.OBJLoader();
let bitmapLoader = new THREE.ImageBitmapLoader();
let fontLoader = new THREE.FontLoader();

let COLOR_GREY = new THREE.MeshStandardMaterial({
  color: 0xffffff,
  roughness: 0.55,
  metalness: 0.5,
  //transparent: true,
  //opacity: 0.2,
});
let COLOR_DARKGREY = new THREE.MeshStandardMaterial({
  color: 0x444444,
  roughness: 0.55,
  metalness: 0.5,
  //map: map,
  //transparent: true,
  //opacity: 0.2,
});
let COLOR_BLACK = new THREE.MeshStandardMaterial({
  color: 0xffffff,
  //side: THREE.DoubleSide,
  //normalScale: new THREE.Vector2(0.1, 0.1),
  roughness: 0.5,
  metalness: 0.8,
});
let BOX_MATERIAL = new THREE.MeshStandardMaterial({
  color: 0xffffff,
  metalness: 0,
  roughness: 0.45,
});

let ENV_MATERIAL = new THREE.MeshStandardMaterial({
  color: 0xffffff,
  metalness: 0,
  roughness: 1,
  side: THREE.BackSide,
});

//let socket = io.connect("http://26.190.87.133:2500");
let socket = io.connect("http://localhost:2500");

let playground;
let mouse = new THREE.Vector2();
let font;

async function loadAsset(loader, path) {
  let promise = new Promise((resolve, reject) => {
    loader.load(
      path,
      function (data) {
        resolve(data);
      },
      undefined,
      function (err) {
        console.log("An error happened");
        console.log(err);
        reject();
      }
    );
  });
  let d = await promise;
  return d;
}
let materials = [];
async function load(data) {
  if (playground == null) {
    materials["Red"] = new THREE.MeshStandardMaterial({
      color: "red",
      roughness: 0.3,
      metalness: 0.4,
    });
    materials["Yellow"] = new THREE.MeshStandardMaterial({
      color: "yellow",
      roughness: 0.3,
      metalness: 0.4,
    });
    materials["Human"] = new THREE.MeshStandardMaterial({
      color: "grey",
      roughness: 0.3,
      metalness: 0.4,
    });
    materials["Elves"] = new THREE.MeshStandardMaterial({
      color: "darkgreen",
      roughness: 0.3,
      metalness: 0.4,
    });
    materials["Undead"] = new THREE.MeshStandardMaterial({
      color: "purple",
      roughness: 0.3,
      metalness: 0.4,
    });
    new THREE.CanvasTexture();
    let map = new THREE.CanvasTexture(
      await loadAsset(bitmapLoader, "textures/hex.jpg")
    );
    COLOR_GREY.setValues({ map: map });
    COLOR_DARKGREY.setValues({ map: map });
    let ground = new THREE.CanvasTexture(
      await loadAsset(bitmapLoader, "textures/metal.jpg")
    );
    COLOR_BLACK.setValues({ map: ground });
    ground.repeat = new THREE.Vector2(4, 4);
    ground.wrapS = THREE.RepeatWrapping;
    ground.wrapT = THREE.RepeatWrapping;
    map = new THREE.CanvasTexture(
      await loadAsset(bitmapLoader, "textures/wood.jpg")
    );
    BOX_MATERIAL.setValues({ map: map });
    //await loadTextures("env1.jpg", ENV_MATERIAL);

    map = new THREE.CanvasTexture(
      await loadAsset(bitmapLoader, "textures/env2.jpg")
    );
    ENV_MATERIAL.setValues({ map: map });

    font = await loadAsset(fontLoader, "style/fonts/Roboto_Regular.json");

    playground = new Lobby(data);
    Animate();
    //playground.UpdateNamePos();
  }
}
let Abilities = [];
Abilities["MoveAttack"] = MoveAttack;

function loadJS(url) {
  return new Promise(function (resolve, reject) {
    var scriptTag = document.createElement("script");
    scriptTag.type = "text/javascript";
    scriptTag.onload = resolve;
    scriptTag.onerror = reject;
    scriptTag.src = url;
    document.body.appendChild(scriptTag);
  });
}
function Animate() {
  requestAnimationFrame(Animate);
  playground.Controls.update();
  playground.Renderer.render(playground.Scene, playground.Camera);
  if (lerp) {
    if (!playground._controls.target.equals(new THREE.Vector3(40, 0, 23))) {
      playground.Controls.target.lerp(new THREE.Vector3(40, 0, 23), 0.01);
    }
  }
}

function joinAsPlayer() {
  $.ajax({
    url: "/join?id=" + playground.Name,
    method: "get",
    error: (err) => {
      console.log(err);
    },
    success: () => {
      window.location.reload();
    },
  });
}
/*
socket.on("endTurn", () => {
  playground.currentUnit.stats.currentMoves = 0;
  console.log("Дописать конец хода");
});
*/
/*
socket.on("unitTurn", (unitID) => {
  if (playground.currentUnit) removeFromQueue(playground.currentUnit.stats.id);
  myQueue.addAction(
    new Action({}, () => {
      playground.currentUnit = unitByID(unitID);
    })
  );
  if (!myQueue.isPlaying) playground.unitTurn();
});
*/
/*
socket.on("newRound", () => {
  console.log("newRound");
  playground.newRound();
});
*/
socket.on("data", (s) => {
  load(s);
});
/*
socket.on("back", (data) => {
  console.log(data);
});*/
/*
socket.on("kill", (u1, u2) => {
  console.log("kill");
  killMessage(u1, u2);
});
socket.on("clientError", (err) => {
  console.log("clientError");
  createError(err);
});

socket.on("sessionEnded", (winner) =>
  myQueue.addAction(
    new Action({ winner: winner }, function (params) {
      log("Победитель - " + params.winner);
    })
  )
);
*/
socket.on("removeUnit", (unitID) => {
  console.log("Удаляю юнита");
  console.log(unitID);
  playground.RemoveUnit(unitID);
});
socket.on("addUnit", (unit) => playground.CreateUnit(unit));
socket.on("log", (data) => {
  log(data);
});

socket.on("nogame", () => log("Такой партии не существует"));

socket.on("message", (sender, msg) => {
  chatMessage(sender, msg);
});
/*
socket.on("Units", (data) => {
  console.log(data);
  let u = playground.Units[data.id];
  u[data.attribute] = data.value;
});
socket.on("Tiles", (data) => {
  console.log(data);
  let t = playground.Tiles[data.id];
  t[data.attribute] = data.value;
});*/
socket.on("Lobby", (data) => {
  //console.log("Lobby");
  //console.log(data);
  let path = playground;
  for (let i = 0; i < data.path.length; i++) {
    path = path[data.path[i]];
  }
  //console.log(path);
  path[data.attribute] = data.value;
  //playground[data.attribute] = data.value;
});
